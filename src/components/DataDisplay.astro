---
import InputField from './InputField.astro';
import Button from './Button.astro';

const { index, slidePosition, dataGroupedByIndex, sliderId } = Astro.props;
const itemList = dataGroupedByIndex[index];
const itemData = itemList ? itemList[0] : null;
---

{itemData ? (
<div class="data-info" data-index={index} data-slide-position={slidePosition} data-slider-id={sliderId}>
  <h2 class="data-name hidden-info">{itemData['scientific name']}</h2>
  <p class="data-name hidden-info">{itemData['common name']}</p>
  
  <div class="input-container">

    <label for={`scientific-name-input-${sliderId}-${slidePosition}`} class="input-label">What is the scientific name of this species?</label>
    
    <div class="input-wrapper">
      <span id={`result-icon-${sliderId}-${slidePosition}`} class="result-icon"></span>
      <div class="shake-container">
      <InputField inputId={`scientific-name-input-${sliderId}-${slidePosition}`} placeholder="Type here..." />
    </div>
      <Button id={`check-button-${sliderId}-${slidePosition}`} text="Check" className="check-button" />
    </div>
  </div>
</div>

  ) : (
    <p>No data available for this index.</p>
  )}

<script>
    import { checkAnswer } from '../utils/checkAnswer.js';

    document.addEventListener('DOMContentLoaded', () => {
     
        document.querySelectorAll('.data-info').forEach((element) => {
          
            const sliderId = element.getAttribute('data-slider-id');
            const slidePosition = parseInt(element.getAttribute('data-slide-position') ?? '0', 10);
            const checkButton = document.getElementById(`check-button-${sliderId}-${slidePosition}`);
            const inputElement = document.getElementById(`scientific-name-input-${sliderId}-${slidePosition}`);
            const resultIconElement = document.getElementById(`result-icon-${sliderId}-${slidePosition}`);

            function handleSubmit() {
                if (inputElement) {
                    inputElement.classList.remove('input-error');

                    const userInput = inputElement.value.trim();

                    if (userInput === '') {
                        void inputElement.offsetWidth;
                        inputElement.classList.add('input-error');

                        return;
                    }

                 
                    inputElement.classList.remove('input-error');

                    const correctAnswer = element.querySelector('h2').textContent;
                    const isCorrect = userInput.trim() === correctAnswer.trim();
                    resultIconElement.textContent = isCorrect ? '✅' : '❌';

                    element.querySelectorAll('.hidden-info').forEach(info => {
                        info.classList.remove('hidden-info');
                    });

                    const labelElement = element.querySelector('.input-label');
                    if (labelElement) {
                        labelElement.remove();
                    }

                    checkAnswer(sliderId, userInput, correctAnswer, slidePosition);

                    const event = new CustomEvent('answersUpdated', { detail: { slidePosition, sliderId } });
                    document.dispatchEvent(event);

                    inputElement.disabled = true;
                    checkButton.disabled = true;
                }
            }

            if (checkButton) {
                checkButton.addEventListener('click', handleSubmit);
            }

        
            if (inputElement) {
                inputElement.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        handleSubmit();
                    }
                });
            }
        });
    });
</script>

<style>

.hidden-info {
    display: none; 
}

</style>