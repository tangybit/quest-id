---
import InputField from './InputField.astro';
import Button from './Button.astro';

const { index, slidePosition, dataGroupedByIndex, sliderId } = Astro.props;
const itemList = dataGroupedByIndex[index];
const itemData = itemList ? itemList[0] : null;

---

{itemData ? (
    <div class="data-info" data-index={index} data-slide-position={slidePosition} data-slider-id={sliderId}>
      <h2 class="data-name hidden-info">{itemData['scientific name']}</h2>
      <p class="data-name hidden-info">{itemData['common name']}</p>
  
      <div class="input-container">
        <label for={`scientific-name-input-${sliderId}-${slidePosition}`} class="input-label">
          What is the scientific name of this species?
        </label>
  
        <div class="input-wrapper">
          <span id={`result-icon-${sliderId}-${slidePosition}`} class="result-icon"></span>
          <div class="shake-container">
            <InputField inputId={`scientific-name-input-${sliderId}-${slidePosition}`} placeholder="Type here..." />
          </div>
        </div>
  
<div class="button-container">
  <Button 
    id={`check-button-${sliderId}-${slidePosition}`} 
    text="Check" 
    className="check-button" 
    iconSrc=""
  />
  
  <Button 
    id={`skip-button-${sliderId}-${slidePosition}`} 
    text="Skip" 
    className="skip-button" 
    iconSrc=""
  />
  
</div>
</div>
</div>
  ) : (
    <p>No data available for this index.</p>
  )}
  

  <script>
    import { checkAnswer, skipAnswer} from '../utils/checkAnswer.js';

    document.addEventListener('DOMContentLoaded', () => {
     
        document.querySelectorAll('.data-info').forEach((element) => {
          
            const sliderId = element.getAttribute('data-slider-id');
            const slidePosition = parseInt(element.getAttribute('data-slide-position') ?? '0', 10);
            const checkButton = document.getElementById(`check-button-${sliderId}-${slidePosition}`);
            const skipButton = document.getElementById(`skip-button-${sliderId}-${slidePosition}`);  // Skip button reference
            const inputElement = document.getElementById(`scientific-name-input-${sliderId}-${slidePosition}`);
            const resultIconElement = document.getElementById(`result-icon-${sliderId}-${slidePosition}`);

            function handleSubmit() {
                if (inputElement) {
                    console.log("Check button clicked"); 
                    inputElement.classList.remove('input-error');

                    const userInput = inputElement.value.trim();

                    if (userInput === '') {
                        void inputElement.offsetWidth;
                        inputElement.classList.add('input-error');
                        return;
                    }

                    const correctAnswer = element.querySelector('h2').textContent;
                    const isCorrect = userInput.trim() === correctAnswer.trim();
                    resultIconElement.textContent = isCorrect ? '✅' : '❌';

                    element.querySelectorAll('.hidden-info').forEach(info => {
                        info.classList.remove('hidden-info');
                    });

                    const labelElement = element.querySelector('.input-label');
                    if (labelElement) {
                        labelElement.remove();
                    }

                    checkAnswer(sliderId, userInput, correctAnswer, slidePosition);

                    const event = new CustomEvent('answersUpdated', { detail: { slidePosition, sliderId } });
                    document.dispatchEvent(event);

                    inputElement.disabled = true;
                    checkButton.disabled = true;
                    skipButton.disabled = true;
                }
            }

            function handleSkip() {
    const correctAnswer = element.querySelector('h2').textContent.trim();

    // Mark as skipped, but don't reveal the answer
    skipAnswer(sliderId, slidePosition, correctAnswer);
    resultIconElement.textContent = '⏭️';

    element.querySelectorAll('.hidden-info').forEach(info => {
        info.classList.add('hidden-info');
    });

    const labelElement = element.querySelector('.input-label');
    if (labelElement) {
        labelElement.remove();
    }

    inputElement.disabled = false;
    checkButton.disabled = false;
    skipButton.style.display = 'none';

    const event = new CustomEvent('skipped', { detail: { slidePosition, sliderId } });
    document.dispatchEvent(event);
}
            if (checkButton) {
                checkButton.addEventListener('click', handleSubmit);
            }

            if (skipButton) {
                skipButton.addEventListener('click', handleSkip);
            }

            if (inputElement) {
                inputElement.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        handleSubmit();
                    }
                });
            }
        });
    });
</script>

<style>

.hidden-info {
    display: none; 
}

</style>